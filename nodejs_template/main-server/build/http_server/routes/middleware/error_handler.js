"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = errorHandler;
exports.bodyParserErrorHandler = bodyParserErrorHandler;

var _logger = _interopRequireDefault(require("../../../logger"));

var _type = _interopRequireDefault(require("service-error/type"));

var _error = require("../../../utils/error");

var _config = require("../../../config");

/**
 * Copyright (c) 2018, 2019 ChibCha COMPANY LIMITED
 *
 */
function errorHandler(err, req, res, next) {
  if (res.headersSent) {
    return next(err);
  }

  let clientError;
  let unauthorizedError;

  if (err.name === 'CustomError') {
    clientError = err.isRootCauseClientError();
  }

  const responseBody = {
    error: (0, _error.getErrorObjectForClient)(err)
  };

  if (unauthorizedError) {
    res.status(403).json(responseBody);

    _logger.default.error({
      message: 'Responded Unauthorized with HTTP code 403',
      responseBody
    });
  } else if (clientError === true) {
    if (err.getCode() === _type.default.QUERY_STRING_VALIDATION_FAILED.code || err.getCode() === _type.default.BODY_VALIDATION_FAILED.code) {
      responseBody.details = err.details;
    }

    if (err.getCode() === _type.default.DATA_VALIDATION_FAILED.code) {
      responseBody.details = err.getDetailsOfErrorWithCode();
    }

    res.status(_config.clientHttpErrorCode).json(responseBody);

    _logger.default.error({
      message: `Responded Bad Request with HTTP code ${_config.clientHttpErrorCode}`,
      responseBody
    });
  } else {
    res.status(_config.serverHttpErrorCode).json(responseBody);

    _logger.default.error({
      message: `Responded Internal Server Error with HTTP code ${_config.serverHttpErrorCode}`,
      responseBody
    });
  }
}

function bodyParserErrorHandler(err, req, res, next) {
  if (res.headersSent) {
    return next(err);
  }

  let errorCode;
  let errorMessage;
  let clientError;

  if (err) {
    if (err.type == 'entity.parse.failed') {
      errorCode = _type.default.BODY_PARSE_FAILED.code;
      errorMessage = _type.default.BODY_PARSE_FAILED.message;
      clientError = true;
    } else if (err.type == 'entity.too.large') {
      errorCode = _type.default.BODY_TOO_LARGE.code;
      errorMessage = _type.default.BODY_TOO_LARGE.message;
      clientError = true;
    } else {
      errorCode = _type.default.BODY_PARSER_ERROR.code;
      errorMessage = `${_type.default.BODY_PARSER_ERROR.message}: ${err.message}`;
    }

    if (clientError) {
      const responseBody = {
        error: {
          code: errorCode,
          message: errorMessage
        }
      };
      res.status(_config.clientHttpErrorCode).json(responseBody);

      _logger.default.error({
        message: `Responded Bad Request with HTTP code ${_config.clientHttpErrorCode}`,
        responseBody
      });
    } else {
      const responseBody = {
        error: {
          code: errorCode,
          message: errorMessage,
          stack: _config.env === 'development' ? err.stack : undefined
        }
      };
      res.status(_config.serverHttpErrorCode).json(responseBody);

      _logger.default.error({
        message: `Responded Internal Server Error with HTTP code ${_config.serverHttpErrorCode}`,
        responseBody
      });
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9odHRwX3NlcnZlci9yb3V0ZXMvbWlkZGxld2FyZS9lcnJvcl9oYW5kbGVyLmpzIl0sIm5hbWVzIjpbImVycm9ySGFuZGxlciIsImVyciIsInJlcSIsInJlcyIsIm5leHQiLCJoZWFkZXJzU2VudCIsImNsaWVudEVycm9yIiwidW5hdXRob3JpemVkRXJyb3IiLCJuYW1lIiwiaXNSb290Q2F1c2VDbGllbnRFcnJvciIsInJlc3BvbnNlQm9keSIsImVycm9yIiwic3RhdHVzIiwianNvbiIsImxvZ2dlciIsIm1lc3NhZ2UiLCJnZXRDb2RlIiwiZXJyb3JUeXBlIiwiUVVFUllfU1RSSU5HX1ZBTElEQVRJT05fRkFJTEVEIiwiY29kZSIsIkJPRFlfVkFMSURBVElPTl9GQUlMRUQiLCJkZXRhaWxzIiwiREFUQV9WQUxJREFUSU9OX0ZBSUxFRCIsImdldERldGFpbHNPZkVycm9yV2l0aENvZGUiLCJjbGllbnRIdHRwRXJyb3JDb2RlIiwic2VydmVySHR0cEVycm9yQ29kZSIsImJvZHlQYXJzZXJFcnJvckhhbmRsZXIiLCJlcnJvckNvZGUiLCJlcnJvck1lc3NhZ2UiLCJ0eXBlIiwiQk9EWV9QQVJTRV9GQUlMRUQiLCJCT0RZX1RPT19MQVJHRSIsIkJPRFlfUEFSU0VSX0VSUk9SIiwic3RhY2siLCJlbnYiLCJ1bmRlZmluZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFJQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFQQTs7OztBQVNlLFNBQVNBLFlBQVQsQ0FBc0JDLEdBQXRCLEVBQTJCQyxHQUEzQixFQUFnQ0MsR0FBaEMsRUFBcUNDLElBQXJDLEVBQTJDO0FBQ3hELE1BQUlELEdBQUcsQ0FBQ0UsV0FBUixFQUFxQjtBQUNuQixXQUFPRCxJQUFJLENBQUNILEdBQUQsQ0FBWDtBQUNEOztBQUVELE1BQUlLLFdBQUo7QUFDQSxNQUFJQyxpQkFBSjs7QUFDQSxNQUFJTixHQUFHLENBQUNPLElBQUosS0FBYSxhQUFqQixFQUFnQztBQUM5QkYs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QU8sRUFBRWE7QUFGSjtBQURZLE9BQXJCO0FBTUF6QixNQUFBQSxHQUFHLENBQUNTLE1BQUosQ0FBV1ksMkJBQVgsRUFBZ0NYLElBQWhDLENBQXFDSCxZQUFyQzs7QUFDQUksc0JBQU9ILEtBQVAsQ0FBYTtBQUNYSSxRQUFBQSxPQUFPLEVBQUcsd0NBQXVDUywyQkFBb0IsRUFEMUQ7QUFFWGQsUUFBQUE7QUFGVyxPQUFiO0FBSUQsS0FaRCxNQVlPO0FBQ0wsWUFBTUEsWUFBWSxHQUFHO0FBQ25CQyxRQUFBQSxLQUFLLEVBQUU7QUFDTFEsVUFBQUEsSUFBSSxFQUFFUSxTQUREO0FBRUxaLFVBQUFBLE9BQU8sRUFBRWEsWUFGSjtBQUdMSyxVQUFBQSxLQUFLLEVBQUVDLGdCQUFRLGFBQVIsR0FBd0JqQyxHQUFHLENBQUNnQyxLQUE1QixHQUFvQ0U7QUFIdEM7QUFEWSxPQUFyQjtBQU9BaEMsTUFBQUEsR0FBRyxDQUFDUyxNQUFKLENBQVdhLDJCQUFYLEVBQWdDWixJQUFoQyxDQUFxQ0gsWUFBckM7O0FBQ0FJLHNCQUFPSCxLQUFQLENBQWE7QUFDWEksUUFBQUEsT0FBTyxFQUFHLGtEQUFpRFUsMkJBQW9CLEVBRHBFO0FBRVhmLFFBQUFBO0FBRlcsT0FBYjtBQUlEO0FBQ0Y7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE4LCAyMDE5IENoaWJDaGEgQ09NUEFOWSBMSU1JVEVEXG4gKlxuICovXG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uLy4uLy4uL2xvZ2dlcic7XG5pbXBvcnQgZXJyb3JUeXBlIGZyb20gJ3NlcnZpY2UtZXJyb3IvdHlwZSc7XG5pbXBvcnQgeyBnZXRFcnJvck9iamVjdEZvckNsaWVudCB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2Vycm9yJztcbmltcG9ydCB7IGVudiwgY2xpZW50SHR0cEVycm9yQ29kZSwgc2VydmVySHR0cEVycm9yQ29kZSB9IGZyb20gJy4uLy4uLy4uL2NvbmZpZyc7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGVycm9ySGFuZGxlcihlcnIsIHJlcSwgcmVzLCBuZXh0KSB7XG4gIGlmIChyZXMuaGVhZGVyc1NlbnQpIHtcbiAgICByZXR1cm4gbmV4dChlcnIpO1xuICB9XG5cbiAgbGV0IGNsaWVudEVycm9yO1xuICBsZXQgdW5hdXRob3JpemVkRXJyb3I7XG4gIGlmIChlcnIubmFtZSA9PT0gJ0N1c3RvbUVycm9yJykge1xuICAgIGNsaWVudEVycm9yID0gZXJyLmlzUm9vdENhdXNlQ2xpZW50RXJyb3IoKTtcbiAgfVxuXG4gIGNvbnN0IHJlc3BvbnNlQm9keSA9IHtcbiAgICBlcnJvcjogZ2V0RXJyb3JPYmplY3RGb3JDbGllbnQoZXJyKSxcbiAgfTtcblxuICBpZiAodW5hdXRob3JpemVkRXJyb3IpIHtcbiAgICByZXMuc3RhdHVzKDQwMykuanNvbihyZXNwb25zZUJvZHkpO1xuICAgIGxvZ2dlci5lcnJvcih7XG4gICAgICBtZXNzYWdlOiAnUmVzcG9uZGVkIFVuYXV0aG9yaXplZCB3aXRoIEhUVFAgY29kZSA0MDMnLFxuICAgICAgcmVzcG9uc2VCb2R5LFxuICAgIH0pO1xuICB9IGVsc2UgaWYgKGNsaWVudEVycm9yID09PSB0cnVlKSB7XG4gICAgaWYgKFxuICAgICAgZXJyLmdldENvZGUoKSA9PT0gZXJyb3JUeXBlLlFVRVJZX1NUUklOR19WQUxJREFUSU9OX0ZBSUxFRC5jb2RlIHx8XG4gICAgICBlcnIuZ2V0Q29kZSgpID09PSBlcnJvclR5cGUuQk9EWV9WQUxJREFUSU9OX0ZBSUxFRC5jb2RlXG4gICAgKSB7XG4gICAgICByZXNwb25zZUJvZHkuZGV0YWlscyA9IGVyci5kZXRhaWxzO1xuICAgIH1cbiAgICBpZiAoZXJyLmdldENvZGUoKSA9PT0gZXJyb3JUeXBlLkRBVEFfVkFMSURBVElPTl9GQUlMRUQuY29kZSkge1xuICAgICAgcmVzcG9uc2VCb2R5LmRldGFpbHMgPSBlcnIuZ2V0RGV0YWlsc09mRXJyb3JXaXRoQ29kZSgpO1xuICAgIH1cbiAgICByZXMuc3RhdHVzKGNsaWVudEh0dHBFcnJvckNvZGUpLmpzb24ocmVzcG9uc2VCb2R5KTtcbiAgICBsb2dnZXIuZXJyb3Ioe1xuICAgICAgbWVzc2FnZTogYFJlc3BvbmRlZCBCYWQgUmVxdWVzdCB3aXRoIEhUVFAgY29kZSAke2NsaWVudEh0dHBFcnJvckNvZGV9YCxcbiAgICAgIHJlc3BvbnNlQm9keSxcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICByZXMuc3RhdHVzKHNlcnZlckh0dHBFcnJvckNvZGUpLmpzb24ocmVzcG9uc2VCb2R5KTtcbiAgICBsb2dnZXIuZXJyb3Ioe1xuICAgICAgbWVzc2FnZTogYFJlc3BvbmRlZCBJbnRlcm5hbCBTZXJ2ZXIgRXJyb3Igd2l0aCBIVFRQIGNvZGUgJHtzZXJ2ZXJIdHRwRXJyb3JDb2RlfWAsXG4gICAgICByZXNwb25zZUJvZHksXG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJvZHlQYXJzZXJFcnJvckhhbmRsZXIoZXJyLCByZXEsIHJlcywgbmV4dCkge1xuICBpZiAocmVzLmhlYWRlcnNTZW50KSB7XG4gICAgcmV0dXJuIG5leHQoZXJyKTtcbiAgfVxuXG4gIGxldCBlcnJvckNvZGU7XG4gIGxldCBlcnJvck1lc3NhZ2U7XG4gIGxldCBjbGllbnRFcnJvcjtcbiAgaWYgKGVycikge1xuICAgIGlmIChlcnIudHlwZSA9PSAnZW50aXR5LnBhcnNlLmZhaWxlZCcpIHtcbiAgICAgIGVycm9yQ29kZSA9IGVycm9yVHlwZS5CT0RZX1BBUlNFX0ZBSUxFRC5jb2RlO1xuICAgICAgZXJyb3JNZXNzYWdlID0gZXJyb3JUeXBlLkJPRFlfUEFSU0VfRkFJTEVELm1lc3NhZ2U7XG4gICAgICBjbGllbnRFcnJvciA9IHRydWU7XG4gICAgfSBlbHNlIGlmIChlcnIudHlwZSA9PSAnZW50aXR5LnRvby5sYXJnZScpIHtcbiAgICAgIGVycm9yQ29kZSA9IGVycm9yVHlwZS5CT0RZX1RPT19MQVJHRS5jb2RlO1xuICAgICAgZXJyb3JNZXNzYWdlID0gZXJyb3JUeXBlLkJPRFlfVE9PX0xBUkdFLm1lc3NhZ2U7XG4gICAgICBjbGllbnRFcnJvciA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVycm9yQ29kZSA9IGVycm9yVHlwZS5CT0RZX1BBUlNFUl9FUlJPUi5jb2RlO1xuICAgICAgZXJyb3JNZXNzYWdlID0gYCR7ZXJyb3JUeXBlLkJPRFlfUEFSU0VSX0VSUk9SLm1lc3NhZ2V9OiAke2Vyci5tZXNzYWdlfWA7XG4gICAgfVxuXG4gICAgaWYgKGNsaWVudEVycm9yKSB7XG4gICAgICBjb25zdCByZXNwb25zZUJvZHkgPSB7XG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgY29kZTogZXJyb3JDb2RlLFxuICAgICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgICByZXMuc3RhdHVzKGNsaWVudEh0dHBFcnJvckNvZGUpLmpzb24ocmVzcG9uc2VCb2R5KTtcbiAgICAgIGxvZ2dlci5lcnJvcih7XG4gICAgICAgIG1lc3NhZ2U6IGBSZXNwb25kZWQgQmFkIFJlcXVlc3Qgd2l0aCBIVFRQIGNvZGUgJHtjbGllbnRIdHRwRXJyb3JDb2RlfWAsXG4gICAgICAgIHJlc3BvbnNlQm9keSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByZXNwb25zZUJvZHkgPSB7XG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgY29kZTogZXJyb3JDb2RlLFxuICAgICAgICAgIG1lc3NhZ2U6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICBzdGFjazogZW52ID09PSAnZGV2ZWxvcG1lbnQnID8gZXJyLnN0YWNrIDogdW5kZWZpbmVkLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIHJlcy5zdGF0dXMoc2VydmVySHR0cEVycm9yQ29kZSkuanNvbihyZXNwb25zZUJvZHkpO1xuICAgICAgbG9nZ2VyLmVycm9yKHtcbiAgICAgICAgbWVzc2FnZTogYFJlc3BvbmRlZCBJbnRlcm5hbCBTZXJ2ZXIgRXJyb3Igd2l0aCBIVFRQIGNvZGUgJHtzZXJ2ZXJIdHRwRXJyb3JDb2RlfWAsXG4gICAgICAgIHJlc3BvbnNlQm9keSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufSJdfQ==